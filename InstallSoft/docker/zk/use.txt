# 1: 安装zookeeper，kafka
docker network create --subnet=131.45.20.0/16 canal_zk_network

# 2:下面2个yml文件需要修改, port防止冲突
cd ./docker/zookeeper/
docker-compose -f zookeeper.yml up -d
cd ./docker/kafka/
docker-compose -f kafka.yml up -d

# 3: 执行下面命令修改kafka参数，请求大小
docker exec canal_kafka1 bash -c "echo -e '\nmessage.max.bytes=10485760' >> /opt/bitnami/kafka/config/server.properties"
docker exec canal_kafka1 bash -c "sed -i 's|#max.request.size=|max.request.size=10485760|g' /opt/bitnami/kafka/config/producer.properties"
docker exec canal_kafka1 bash -c "echo -e '\nfetch.max.bytes=10485760' >> /opt/bitnami/kafka/config/consumer.properties"

docker exec canal_kafka2 bash -c "echo -e '\nmessage.max.bytes=10485760' >> /opt/bitnami/kafka/config/server.properties"
docker exec canal_kafka2 bash -c "sed -i 's|#max.request.size=|max.request.size=10485760|g' /opt/bitnami/kafka/config/producer.properties"
docker exec canal_kafka2 bash -c "echo -e '\nfetch.max.bytes=10485760' >> /opt/bitnami/kafka/config/consumer.properties"

# 4: 设置kafka数据缓存时长
docker exec canal_kafka1 bash -c "sed -i 's|log.retention.hours=168|log.retention.hours=720|g' /opt/bitnami/kafka/config/server.properties"
docker exec canal_kafka2 bash -c "sed -i 's|log.retention.hours=168|log.retention.hours=720|g' /opt/bitnami/kafka/config/server.properties"

# 5: 设置外网访问权限 下面得127.0.0.1更改为本机外网ip, 9192,9193更改为对应容器得映射port
docker exec canal_kafka1 bash -c "sed -i 's|advertised.listeners=PLAINTEXT:\/\/:9092|advertised.listeners=PLAINTEXT:\/\/127.0.0.1:9192|g' /opt/bitnami/kafka/config/server.properties"
docker exec canal_kafka2 bash -c "sed -i 's|advertised.listeners=PLAINTEXT:\/\/:9092|advertised.listeners=PLAINTEXT:\/\/127.0.0.1:9193|g' /opt/bitnami/kafka/config/server.properties"

docker restart canal_kafka1 canal_kafka2

